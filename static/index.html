<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TidalDL</title>
    <link rel="stylesheet" href="/css/style.css"> 
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <a id="github-btn" class="corner-btn" href="https://github.com/sky8282/Tidal-Web-Downloader" target="_blank" title="GitHub 项目">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
    </a>

    <button id="settings-btn" class="corner-btn" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.93-3.32a.5.5 0 0 0-.61-.22l-2.39.96a7.007 7.007 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 14.3 2h-4.6a.5.5 0 0 0-.49.42l-.36 2.54a7.007 7.007 0 0 0-1.63.94l-2.39-.96a.5.5 0 0 0-.61.22L2.3 8.84a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.93 3.32a.5.5 0 0 0 .61.22l2.39-.96c.48.39 1.03.72 1.63.94l.36 2.54c.04.24.25.42.49.42h4.6c.24 0 .45-.18.49-.42l.36-2.54c.6-.22 1.15-.55 1.63-.94l2.39.96a.5.5 0 0 0 .61-.22l1.93-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7z"/>
        </svg>
    </button>

    <button id="login-btn" class="corner-btn" title="Click to run login.py">
        --
    </button>

    <div class="container">
        <header>
            <h1>TidalDL</h1>
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Enter keywords or a Tidal link...">
                    <button id="searchButton">Search</button>
                    <button id="downloadUrlButton">Download</button>
                </div>
                <div class="search-tabs">
                    <button class="tab-btn active" data-search-type="al">Album</button>
                    <button class="tab-btn" data-search-type="s">Single</button>
                    <button class="tab-btn" data-search-type="a">Artist</button>
                    <button class="tab-btn" data-search-type="v">Video</button>
                </div>
            </div>
        </header>
        <main>
            <div id="results-wall"></div>
            <div id="artist-page-container" style="display: none;"></div>
            
            <div id="loading-indicator" class="loading-indicator" style="display: none;">
                <div class="loader"></div>
            </div>
        </main>
    </div>

    <div id="tracklist-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <div class="modal-header">
                <div id="modal-title-container" class="modal-title-container">
                    <img id="modal-album-art" src="" alt="Album Art">
                    <h3 id="modal-title">Tracklist</h3>
                </div>
                <button id="modal-download-album-btn" class="action-btn" title="Download Album">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                </button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <div id="video-modal" class="modal">
        <div class="modal-content video-modal-content">
            <span class="modal-close-btn">&times;</span>
            <div class="modal-header">
                <h3 id="video-modal-title">Video</h3>
            </div>
            <div id="video-modal-body">
                <video id="player-video-element" controls style="width: 100%; height: auto; background-color: #000;"></video>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="modal">
        <div class="modal-content settings-modal-content">
            <span class="modal-close-btn">&times;</span>
            <h3>Settings</h3>
            <div id="settings-body" class="settings-body">
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-label">
                            <label for="setting-download-hires">Enable Hi-Res Downloads</label>
                            <button class="help-btn" data-help-id="hires-help">?</button>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-download-hires" class="setting-checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="hires-help" class="help-text">
                        <p>When checked, the app will prioritize downloading Hi-Res audio when available. Otherwise, it will automatically fall back to Lossless.</p>
                        <p><strong>Note:</strong> Hi-Res files are typically much larger than Lossless files.</p>
                    </div>
                </div>

                <div class="setting-item" id="setting-hires-threads-container">
                    <div class="setting-label">
                        <label for="setting-hires-threads">Hi-Res Download Thread Count</label>
                        <button class="help-btn" data-help-id="hires-threads-help">?</button>
                    </div>
                    <input type="number" id="setting-hires-threads" class="setting-input" min="1" max="20">
                    <div id="hires-threads-help" class="help-text">
                        <p>Set the number of concurrent connections when downloading Hi-Res audio chunks. Higher values may accelerate download speeds but could also cause network instability or trigger server throttling.</p>
                        <p>Recommended range: 3–10, default value: 5</p>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-label">
                            <label for="setting-disk-cache">Enable Caching</label>
                            <button class="help-btn" data-help-id="disk-cache-help">?</button>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-disk-cache" class="setting-checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="disk-cache-help" class="help-text">
                        <p><strong>Recommended to enable</strong></p>
                        <p>Once enabled, all downloaded temporary files will be stored in a `tmp` subfolder within the final download directory, enabling resume-enabled downloads. Even if the app is closed or a download fails, subsequent downloads of the same track will resume from where they left off.</p>
                        <p>After closing, the system temporary folder will be used. Files will be lost after the application closes.</p>
                    </div>
                </div>

                <hr class="setting-divider">

                <div class="setting-item">
                    <div class="setting-label">
                        <label for="setting-folder-format">Folder Format</label>
                        <button class="help-btn" data-help-id="folder-format-help">?</button>
                    </div>
                    <input type="text" id="setting-folder-format" class="setting-input">
                    <div id="folder-format-help" class="help-text">
                        <p>This setting only applies when downloading entire albums using the “Select Folder” feature. Available placeholders:</p>
                        <ul>
                            <li><code>{artist}</code> - Artist</li>
                            <li><code>{album}</code> - Album</li>
                            <li><code>{year}</code> - Year</li>
                        </ul>
                        <p>Example: <code>{artist}/{album} ({year})</code></p>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <label for="setting-filename-format">File Name Format</label>
                        <button class="help-btn" data-help-id="filename-format-help">?</button>
                    </div>
                    <input type="text" id="setting-filename-format" class="setting-input">
                    <div id="filename-format-help" class="help-text">
                        <p>Available placeholders:</p>
                        <ul>
                            <li><code>{trackNumber}</code> - Track Number (automatically padded with leading zeros)</li>
                            <li><code>{title}</code> - Title</li>
                            <li><code>{artist}</code> - Artist</li>
                            <li><code>{album}</code> - Album</li>
                        </ul>
                        <p>Example: <code>{trackNumber}. {title}</code></p>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <label>Metadata fields</label>
                    </div>
                    <div id="metadata-settings-container" class="metadata-checkboxes">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="restore-defaults-btn" class="action-btn">Restore default settings</button>
            </div>
        </div>
    </div>

    <div id="download-queue-modal" class="modal">
        <div class="modal-content download-queue-modal-content">
            <span class="modal-close-btn">&times;</span>
            <h3>Download Queue</h3>
            <div id="download-queue-body" class="download-queue-body">
                </div>
        </div>
    </div>
    
    <div id="login-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
             <span class="modal-close-btn" onclick="document.getElementById('login-modal').classList.remove('is-visible')">&times;</span>
            <h3>Login Output</h3>
            <pre id="login-output">Click run to start...</pre>
        </div>
    </div>

    <div id="global-player" class="global-player">
        <img id="player-album-art" src="" alt="Album Art">
        <div class="player-controls">
            <button id="player-prev-btn" class="player-btn" title="Previous" disabled>
                <svg viewBox="0 0 24 24"><g transform="scale(-1 1) translate(-24, 0)"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6l-8.5 6z"></path></g></svg>
            </button>
            <button id="player-play-pause-btn" class="player-btn large" title="Play" disabled>
                <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                <svg class="pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                <div class="loader"></div>
            </button>
            <button id="player-next-btn" class="player-btn" title="Next" disabled>
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
            </button>
            <button id="player-stop-btn" class="player-btn" title="Stop">
                <svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
            </button>
            <div class="volume-container">
                <button id="player-volume-btn" class="player-btn" title="Volume">
                    <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3z"></path></svg>
                </button>
                <div class="volume-popup">
                    <input type="range" id="volume-slider" min="0" max="100" value="100" class="volume-slider">
                </div>
            </div>
        </div>
    </div>

    <button id="back-to-top" class="back-to-top-btn" title="Back to top">
        <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg>
    </button>
    
    <div id="download-manager" class="download-manager">
        <div id="download-progress-bar-container">
            <div id="download-progress-bar"></div>
        </div>
        <div id="download-queue-count" class="queue-count"></div>
        <div class="status-text">
            <div id="download-album-title"></div>
            <div id="download-track-status"></div>
        </div>
        <button id="download-cancel-btn" class="download-cancel-btn" title="Cancel all tasks">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </button>
    </div>

    <audio id="player-audio-element" style="display:none;"></audio>
    
    <script src="/js/app.js" type="module"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loginBtn = document.getElementById('login-btn');
            const outputDiv = document.getElementById('login-output');
            
            try {
                const res = await fetch('/api/region');
                const data = await res.json();
                loginBtn.textContent = data.region || '??';
            } catch (e) {
                console.error("Failed to fetch region:", e);
                loginBtn.textContent = 'Err';
            }

            loginBtn.addEventListener('click', async () => {
                document.getElementById('login-modal').classList.add('is-visible');
                outputDiv.textContent = "Starting process...\n";
                
                try {
                    const response = await fetch('/api/run-login');
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const text = decoder.decode(value, { stream: true });
                        outputDiv.textContent += text;
                        outputDiv.scrollTop = outputDiv.scrollHeight;
                    }
                } catch (e) {
                    outputDiv.textContent += "\nError: " + e.message;
                }
            });
        });
    </script>
</body>
</html>
